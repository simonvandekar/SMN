---
title: "Homework: *Despicable Me* First-level Analysis"
editor: visual
format:
  html:
    toc: true
    standalone: true
    code-fold: true
---

## Overview

**Goal:** *Effectively* implement fMRI batch first-level analysis for the *Despicable Me* data for the subset of participants assigned to you. "Effectively" means quality checking intermediate steps.

**Instructions:** There are 100 participant folders in the `data/RBC/HBN_BIDS/` [folder](https://vanderbilt.box.com/s/7tb7738agklrsp3sw7d1w7c36g0bn091). One is assigned to you in this [Google doc](https://docs.google.com/document/d/1hYff8xvkZmRjfio6mS5hIENpfoW19KzafYFAcMh5DV4/edit?usp=sharing) where we will put the quality assurance (QA) summaries.

**Deliverables:** This document edited to include

-   Commented code describing each step.
-   Visualizations and commentary, as requested specifically, below.
-   All the output from your preprocessing steps included in the participant's folder on the Box drive.
-   QA summaries generated by FSL in the [Google doc](https://docs.google.com/document/d/1hYff8xvkZmRjfio6mS5hIENpfoW19KzafYFAcMh5DV4/edit?usp=sharing).

**Hint:** This file is located at `3first-level_analysis/homework/``first-level_analysis``/``first-level_analysis.``qmd`.

## Batch brain extraction (20 pts)

After our last class, we should have found one of two brain extraction methods that worked well for these data and decided as a class (if not, yet, remind Simon about that we need to do this). Run bias correction and brain extraction on your full subset of images to get the output you need as input for FEAT. You can work in your group or as a class to write a batch script, or you can share code to do this.

Write a loop in `R` in this document to create a visualization of one or a couple slices for each participant to quality check the brain extraction and add it to this document to be submitted as an html.

## fMRI first-level analysis (30 pts)

Start the FSL GUI from the command line by typing `fsl` and then open the FEAT fMRI Analysis (can also do this directly typing `Feat_gui` at the command line. Open the `.fsf` file you produced from your last homework and set it up to perform the statistical analysis for the *Despicable Me* data. All the prior settings you used before loaded in.

**Hint:** On my laptop, when I change the tab in the FEAT GUI, all the buttons disappear; if you adjust the window size, they reappear.

**Do these things**:

-   Set the temporal filtering high-pass filtering to 130 seconds.
-   Make sure you have the right slice timing file. This should be the same for all participants you are analyzing.
- Select all 4D Nifti images for the subset of participants you are analyzing.
- Select all brain-extracted structural images for the subset of participants you are analyzing. **Hint:** They have to be in the same order as the 4D fMRI images.
-   Construct two events, include the temporal derivative and apply temporal filtering to the event file. Use the double gamma HRF.
    1. Positive valence emotions
    2. Negative valence emotions
- Construct three contrasts
    1. Positive valence emotions (versus baseline/unmodeled)
    2. Negative valence emotions (versus baseline/unmodeled)
    3. Positive minus negative emotions

**Include a screenshot of your design in here, in your html submission.**

Run the analysis. **Hint:** You might want to run it for one person and check the output. Then run it for everyone in your subset and run it overnight.

## Deliverables (10 pts)

### Registration QA


* Write a loop or `lapply` command to print all the functional-to-standard registration images ("Registration of example_func to standard") into this document. Include the subject ID in the output so you can identify who they belong to. **Hint:** They are stored in the participants `.feat` folder output in the `mc` folder and you can print from loops using `results-'asis'` and `cat` to print the markdown syntax you need.
* Create a list of participants whose registration is bad that we might exclude from analysis.

### Motion QA

* Write a loop or `lapply` command to print all the motion plots ("MCFLIRT estimated mean displacement (mm)") into this document. Include the subject ID in the output so you can identify who they belong to. **Hint:** They are stored in the participants `.feat` folder output in the `mc` folder and you can print from loops using `results-'asis'` and `cat` to print the markdown syntax you need.
* Create a list of participants whose mean relative displacement is larger than 0.5mm. We will exclude those participants from the analyses.

